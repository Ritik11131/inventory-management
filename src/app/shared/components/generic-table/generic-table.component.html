<div class="px-4 md:px-6 lg:px-8">
    <p-toolbar styleClass="bg-primary-reverse border-bottom-none border-noround">
        <div class="p-toolbar-group-start">
            <!-- @for (action of availableActions; track $index) {
                <p-button [pTooltip]="action.label" tooltipPosition="bottom" [text]="true" [outlined]="true" 
                          [icon]="action.icon" class="mr-2"
                          (onClick)="invokeAction(action.action)" />
            } -->

            <p-menu appendTo="body" [model]="menuItems" [popup]="true" #menu></p-menu>
            <p-button  [text]="true" [outlined]="true"  label="Manage" icon="pi pi-cog" (click)="menu.toggle($event)"></p-button>
            <!-- <p-button [pTooltip]="'Create New'" tooltipPosition="bottom" [text]="true" [outlined]="true" icon="pi pi-plus" class="mr-2" (onClick)="onNewUser()" />
            <p-button [pTooltip]="'Link RTO'" tooltipPosition="bottom" [text]="true" [outlined]="true" icon="pi pi-link" class="mr-2" (onClick)="onLinkRTO()" />
            <p-button [pTooltip]="'Transfer Inventory'" tooltipPosition="bottom" [text]="true" [outlined]="true" icon="pi pi-external-link" class="mr-2" (onClick)="onTransferInventory()" />
            <p-button [pTooltip]="'Bulk Upload'" tooltipPosition="bottom" [text]="true" [outlined]="true" icon="pi pi-cloud-upload" (onClick)="onUpload()" />
            <p-button [pTooltip]="'Export Sample Bulk Upload .txt File'" tooltipPosition="bottom" [text]="true" [outlined]="true" icon="pi pi-file-o" (onClick)="onExportSample()" />
            <p-button [pTooltip]="'Export To CSV'" tooltipPosition="bottom" [text]="true" [outlined]="true" icon="pi pi-print" (onClick)="onPrint()" /> -->
        </div>
        <div class="p-toolbar-group-end">
            @if(toolbarRightActions.length) {
                @for (action of toolbarRightActions; track $index) {
                    @if(action.type === 'button') {
                        <p-button label="Save" icon="pi pi-check" />
                    }
        
                    @if(action.type === 'dropdown') {
                        <p-dropdown styleClass="mr-2" appendTo="body" [showClear]="true" [options]="action.options" (onChange)="onDropdownChange($event)"
                            [optionLabel]="action.dropdownKeys.nameKey" [placeholder]="action.placeholder" />
                    }
                }
            }
            <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input [disabled]="!data.length" pInputText placeholder="Search" (input)="onSearch($event)" />
            </span>
        </div>
    </p-toolbar>



    <p-table #dt [value]="data" [rows]="rows" [columns]="columns" [paginator]="true" [globalFilterFields]="globalFilterFields"
        [(selection)]="selection" [rowHover]="true" [scrollable]="true" [exportFilename]="exportFilename"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" [showCurrentPageReport]="true"
        (selectionChange)="onSelectionChange($event)" [rowsPerPageOptions]="[10, 25, 50]"
        styleClass="p-datatable-sm p-datatable-gridlines">

        <!-- Dynamic Columns -->
        <ng-template pTemplate="header">
            <tr>
                @if (selectionMode !== 'none') {
                    <th pFrozenColumn style="width: 4rem">
                        @if(selectionMode === 'multiple') {
                            <p-tableHeaderCheckbox/>
                        }
                    </th>
                }
                @for (col of columns; track $index) {
                <th pFrozenColumn [frozen]="col.frozen || false" alignFrozen="right" pSortableColumn="{{ col.field }}" [style.minWidth]="col.minWidth || '15rem'">
                    {{ col.header }} <p-sortIcon field="{{ col.field }}"></p-sortIcon>
                </th>
                }
                @if(actions.length) {
                    <th [style.minWidth]="'8rem'" pFrozenColumn alignFrozen="right" [frozen]="actions.length > 0">Actions</th>
                }
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
            <tr>
                @if(selectionMode !== 'none') {   
                    <td pFrozenColumn>
                        @if(selectionMode === 'multiple') {
                            <p-tableCheckbox [value]="item"/>
                        } @else if(selectionMode === 'single') {
                            <p-tableRadioButton [value]="item" />
                        }
                    </td>
                }
                @for (col of columns; track $index) {
                    @if(col.field === 'active' || col.field === 'activationStatusText' || col.field === 'inStock' || col?.chip) {
                        <td pFrozenColumn alignFrozen="right" [frozen]="col?.frozen">
                            <p-tag [severity]="(col.field === 'iccid') ? (item['activationStatus'] ? 'success' : 'danger') : col.field === 'activationStatusText' ? (item[col.field] === 'Active' ? 'success' : 'danger') : item[col.field] ? 'success' : 'danger'" 
                                   [value]="(col.field === 'vehicle' && col.subfield === 'vehicleNo') ? (item[col.field]?.[col.subfield] || '-') : (col.field === 'iccid') ? (item[col.field]) : (col.field === 'active') ? (item[col.field] ? 'ACTIVE' : 'INACTIVE') : (col.field === 'activationStatusText') ? (item[col.field]) : (item[col.field] ? 'INSTOCK' : 'OUTOFSTOCK')"
                                   (click)="col?.showOverlay ? showOverlay(col,item, $event, op) : null" [ngClass]="{'cursor-pointer': col?.showOverlay}" />
                                <p-overlayPanel #op appendTo="body">
                                    <div class="flex flex-column w-30rem">
                                        @if(selectedColumn === 'iccid') {
                                        @if(selectedOverlayObject.simDetails) {
                                        <span class="font-medium text-900 block mb-2">SIM Details</span>
                                        <div class="formgrid grid">
                                            <!-- First Row: Two Columns -->
                                            <div class="field col-12 sm:col-6">
                                                <p class="mb-1 font-bold">{{ selectedOverlayObject?.simDetails?.provider?.providerName }}</p>
                                                <p class="mt-0  text-sm text-color-secondary">Provider</p>
                                            </div>
                                            <div class="field col-12 sm:col-6 text-right ">
                                                <p class="mb-1 font-bold">{{ selectedOverlayObject?.simDetails?.activationOn | date}}</p>
                                                <p class="mt-0  text-sm text-color-secondary">Activation On:</p>
                                            </div>
                                
                                            <!-- Second Row: Three Columns -->
                                            <div class="field col-12 sm:col-4 text-left">
                                                <p class="mb-1 font-bold">{{ selectedOverlayObject?.simDetails?.primarySimNo }}</p>
                                                <p class="mt-0  text-sm text-color-secondary">Primary SIM No:</p>
                                                <p class="mb-1 font-bold">{{ selectedOverlayObject?.simDetails?.secondarySimNo }}</p>
                                                <p class="mt-0  text-sm text-color-secondary">Secondary SIM No:</p>
                                
                                            </div>
                                            <div class="field col-12 sm:col-4 text-center">
                                                <p class="mb-1 font-bold">{{ selectedOverlayObject?.simDetails?.primaryOpt }}</p>
                                                <p class="mt-0  text-sm text-color-secondary">Primary Operator:</p>
                                                <p class="mb-1 font-bold">{{ selectedOverlayObject?.simDetails?.secondaryOpt }}</p>
                                                <p class="mt-0  text-sm text-color-secondary">Secondary Operator:</p>
                                
                                
                                            </div>
                                            <div class="field col-12 sm:col-4 text-right">
                                                <p class="mb-1 font-bold">{{ selectedOverlayObject?.simDetails?.primaryValidTill | date }}</p>
                                                <p class="mt-0  text-sm text-color-secondary">Primary Valid Till:</p>
                                                <p class="mb-1 font-bold">{{ selectedOverlayObject?.simDetails?.secondaryValidTill | date }}</p>
                                                <p class="mt-0  text-sm text-color-secondary">Secondary Valid Till:</p>
                                            </div>
                                        </div>
                                        } @else {
                                        <p-button (onClick)="onActivate($event, item)" label="Activate Sim" icon="pi pi-eject" />
                                        }
                                        } @else if(selectedColumn === 'vehicleNo') {
                                        @if(selectedOverlayObject) {
                                        <span class="font-medium text-900 block mb-2">Vehicle Details</span>
                                        <div class="formgrid grid">
                                            <!-- First Row: Two Columns -->
                                            <div class="field col-12 sm:col-6">
                                              <p class="mb-1 font-bold">{{ selectedOverlayObject?.vehicleNo }}</p>
                                              <p class="mt-0 text-sm text-color-secondary">Vehicle No:</p>
                                            </div>
                                            <div class="field col-12 sm:col-6 text-right">
                                              <p class="mb-1 font-bold">{{ selectedOverlayObject?.manufacturingYear }}</p>
                                              <p class="mt-0 text-sm text-color-secondary">Manufacturing Year:</p>
                                            </div>
                                          
                                            <!-- Second Row: Three Columns -->
                                            <div class="field col-12 sm:col-4 text-left">
                                              <p class="mb-1 font-bold">{{ selectedOverlayObject?.chassisNo }}</p>
                                              <p class="mt-0 text-sm text-color-secondary">Chassis No:</p>
                                              <p class="mb-1 font-bold">{{ selectedOverlayObject?.engineNo }}</p>
                                              <p class="mt-0 text-sm text-color-secondary">Engine No:</p>
                                            </div>
                                            <div class="field col-12 sm:col-4 text-center">
                                              <p class="mb-1 font-bold">{{ selectedOverlayObject?.vehicleMake }}</p>
                                              <p class="mt-0 text-sm text-color-secondary">Vehicle Make:</p>
                                              <p class="mb-1 font-bold">{{ selectedOverlayObject?.vehicleModel }}</p>
                                              <p class="mt-0 text-sm text-color-secondary">Vehicle Model:</p>
                                            </div>
                                            <div class="field col-12 sm:col-4 text-right">
                                              <p class="mb-1 font-bold">{{ selectedOverlayObject?.vehicleCategory?.name }}</p>
                                              <p class="mt-0 text-sm text-color-secondary">Vehicle Category:</p>
                                            </div>
                                          </div>
                                        } @else if(!selectedOverlayObject && item.activationStatus && item.inStock) {
                                        <p-button (onClick)="onFitment($event, item)" label="Create Fitment" icon="pi pi-id-card" />
                                        }
                                        }
                                    </div>
                                </p-overlayPanel>
                        </td>
                    }  @else {
                        @if(col.field === 'index') {
                            <td>{{ rowIndex + 1 }}</td>
                        } @else if (col.nested) {
                            <td>
                                @if (col.subfield) {
                                    @if (col.nextsubfield) {
                                        {{ col?.type === 'date' ? ((item[col.field]?.[col.subfield]?.[col.nextsubfield] | date) || '-') : (item[col.field]?.[col.subfield]?.[col.nextsubfield] || '-') }}
                                    } @else {
                                        {{ col?.type === 'date' ? ((item[col.field]?.[col.subfield] | date) || '-') : (item[col.field]?.[col.subfield] || '-') }}
                                    }
                                } @else {
                                    {{ '-' }}
                                }
                            </td>
                        } @else {
                            <td>{{item[col.field] || '-'}}</td>
                        }
                    }
                }
                @if(actions.length) {
                    <td pFrozenColumn alignFrozen="right" [frozen]="actions.length > 0">
                        <i class="pi pi-ellipsis-h text-md text-primary cursor-pointer" (click)="loadActionMenuItems(item); actionMenu.toggle($event)"></i>
                        <p-menu appendTo="body" #actionMenu [model]="actionMenuItems" popup="true"></p-menu>
                    </td>
                    <!-- <td pFrozenColumn alignFrozen="right" [frozen]="actions.length > 0">
                        @for(action of actions; track $index) {
                    @if(action === 'edit') {
                    <i [pTooltip]="'Edit'" tooltipPosition="bottom" (click)="onEdit(item)"
                        class="pi pi-pencil ml-2 text-sm text-primary cursor-pointer"></i>
                    }
                
                    @if(action === 'delete') {
                    <i [pTooltip]="'Delete'" tooltipPosition="bottom" (click)="onDelete($event,item)"
                        class="pi pi-trash ml-4 text-sm text-red-500 cursor-pointer"></i>
                    }

                    @if(action === 'activate') {
                        @if(item.activationStatusText !== 'Active') {
                            <i [pTooltip]="'Activate'" tooltipPosition="bottom" (click)="onActivate($event,item)"
                                class="pi pi-eject ml-4 text-sm text-primary-500 cursor-pointer"></i>
                        }
                    }

                    @if(action === 'fitment') {
                        @if(item.activationStatus && item.inStock) {
                            <i [pTooltip]="'Fitment'" tooltipPosition="bottom" (click)="onFitment($event,item)"
                                class="pi pi-id-card ml-4 text-sm text-primary-500 cursor-pointer"></i>
                        }
                    }
                    }
                </td> -->
                }
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7" class="sm:text-center text-left">
                    @if(isDataLoading) {
                        <p-progressSpinner ariaLabel="loading" styleClass="w-3rem h-3rem" />
                    } @else {
                        No Data Found.
                    }
                </td>
            </tr>
        </ng-template>

        <!-- Summary -->
        <ng-template pTemplate="summary">
            <div class="flex align-items-center justify-content-between">
                In total there are {{ data ? data.length : 0 }} items.
            </div>
        </ng-template>
    </p-table>


    <p-confirmDialog [style]="{ width: '300px' }" />



</div>